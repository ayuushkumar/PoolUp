<div class="page-container" style="display: grid; place-items: center; min-height: 80vh;">
    <div class="page-header" style="margin-bottom: 1rem;">
        <h2>Chat about Ride</h2>
    </div>
    <div class="chat-container">
        <div id="chat-box">
            <% if(messages && messages.length > 0) { %>
                <% messages.forEach(msg => { %>
                    <p><strong><%= msg.sender.name %>:</strong> <%= msg.message %></p>
                <% }); %>
            <% } else { %>
                 <p style="text-align: center; color: var(--text-secondary);">No messages yet. Say hello!</p>
            <% } %>
        </div>
        <form id="chat-form">
            <input type="text" id="message-input" placeholder="Type a message..." required autocomplete="off">
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
    </div>
</div>

<script>
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatBox = document.getElementById('chat-box');

    const carpoolId = '<%= carpoolId %>';
    const userId = '<%= user.id %>';
    const userName = '<%= user.name %>';

    const ws = new WebSocket(`ws://${window.location.host}`);

    ws.onopen = () => {
        console.log('Connected to WebSocket');
        ws.send(JSON.stringify({ type: 'join', carpoolId: carpoolId }));
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'message') {
            const messageElement = document.createElement('p');
            messageElement.innerHTML = `<strong>${data.name}:</strong> ${data.message}`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    };

    /* ------------------------------------------------------
       LOCAL STORAGE: Persist username across site visits
    ------------------------------------------------------ */
    if (!localStorage.getItem("username")) {
        localStorage.setItem("username", userName);
    }
    console.log("Loaded username from localStorage:", localStorage.getItem("username"));

    /* ------------------------------------------------------
       SESSION STORAGE: Save chat draft per browser tab
    ------------------------------------------------------ */
    if (sessionStorage.getItem("draftMessage")) {
        messageInput.value = sessionStorage.getItem("draftMessage");
    }

    messageInput.addEventListener("input", () => {
        sessionStorage.setItem("draftMessage", messageInput.value);
    });

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            ws.send(JSON.stringify({
                type: 'chat',
                carpoolId: carpoolId,
                userId: userId,
                name: userName,
                message: message
            }));

            // Clear draft after sending
            sessionStorage.removeItem("draftMessage");
            messageInput.value = '';
        }
    });
</script>
